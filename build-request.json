{
  "kind": "build_request",
  "title": "Add Real Stripe Payment & Coin Recharge System",
  "projectName": "Shake AI",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Add backend support for coin purchase plans: define three packages (100 coins = $1.99, 500 coins = $7.99, 1000 coins = $14.99) stored in the actor state. Expose methods to list plans, create a Stripe checkout session (live mode), verify a completed Stripe session, and credit coins to the caller's balance upon successful payment.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-10",
          "msg-12"
        ],
        "quotes": [
          "100 coins = $1.99، 500 coins = $7.99، 1000 coins = $14.99",
          "Real Stripe Payment Integration (live mode)"
        ]
      },
      "acceptanceCriteria": [
        "Backend actor exposes a `getCoinPlans` method returning the three packages with ID, coin amount, and price in cents.",
        "Backend actor exposes a `createStripeCheckoutSession` method that calls the Stripe API (live mode) and returns a checkout URL.",
        "Backend actor exposes a `verifyAndCreditCoins` method that verifies a Stripe session ID and credits the correct coin amount to the caller's balance.",
        "Coin balance is updated atomically after successful payment verification.",
        "All Stripe API calls use live-mode credentials (not test keys)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Update the frontend CoinPurchaseDialog to display the three real coin packages (100/$1.99, 500/$7.99, 1000/$14.99), redirect to a live Stripe checkout session when a package is selected, and handle the success/cancel return flows by crediting coins and updating the displayed balance.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-10",
          "msg-12"
        ],
        "quotes": [
          "Coin Packages: 100 coins = $1.99، 500 coins = $7.99، 1000 coins = $14.99",
          "Real Stripe Payment Integration (live mode)"
        ]
      },
      "acceptanceCriteria": [
        "CoinPurchaseDialog shows all three packages with correct coin amounts and prices.",
        "Clicking a package triggers a backend call to create a live Stripe checkout session and redirects the user to the Stripe-hosted payment page.",
        "PaymentSuccessScreen parses the session ID and plan ID from the URL, calls the backend to verify and credit coins, then shows success with updated balance.",
        "PaymentFailureScreen informs the user that no charge was made and provides a retry option.",
        "Coin balance in the header updates immediately after a successful purchase."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Ensure the frontend environment configuration supports real (live-mode) Stripe publishable key via the VITE_STRIPE_PUBLISHABLE_KEY environment variable. Update frontend/.env.example to document that only live-mode keys should be used.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-9",
          "msg-10"
        ],
        "quotes": [
          "No demo",
          "real Stripe live mode integration"
        ]
      },
      "acceptanceCriteria": [
        "frontend/.env.example clearly documents VITE_STRIPE_PUBLISHABLE_KEY as a required live-mode key.",
        "The app uses VITE_STRIPE_PUBLISHABLE_KEY for all Stripe.js initialization.",
        "No test/demo key placeholders remain in the default env files."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Add a per-user coin transaction history entry for every coin purchase, recording the plan ID, coin amount credited, Stripe session ID, and timestamp. Expose this via the existing transaction history backend method so it appears in TransactionHistoryPanel.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-10"
        ],
        "quotes": [
          "Coin Balance System: users کا coin balance track کرنا"
        ]
      },
      "acceptanceCriteria": [
        "A successful coin purchase creates a transaction record with type 'credit', feature name matching the plan (e.g., 'Coin Purchase – 500 coins'), amount, and timestamp.",
        "TransactionHistoryPanel displays coin purchase transactions alongside AI feature usage transactions.",
        "Transaction history is ordered with most recent first."
      ]
    }
  ],
  "constraints": [
    "Use real Stripe live-mode API only — no test/sandbox/demo mode.",
    "Do not modify files listed in frontend.immutablePaths.",
    "All backend logic must remain in the single main actor (backend/main.mo)."
  ],
  "nonGoals": [
    "Stripe test/sandbox mode integration.",
    "Adding new AI features beyond what already exists.",
    "Changing coin costs for existing AI actions.",
    "Any branding or naming changes (Shake AI naming is already complete)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}